<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧矿井监测平台</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #004085;
        }
        .navbar-brand {
            color: #ffffff !important;
        }
        .navbar-nav .nav-link {
            color: #ffffff !important;
        }
        .header {
            background: url('/static/your-image.jpg') no-repeat center center;
            background-size: cover;
            color: white;
            padding: 100px 0;
            text-align: center;
            position: relative;
            margin-bottom: 80px; /* 这里可以调整数值，增大或减少距离 */
        }
        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* 半透明的黑色遮罩 */
            z-index: 1;
        }
        .header h1,
        .header p {
            position: relative;
            z-index: 2;
        }
        .header h1 {
            font-size: 3rem;
            font-weight: 700;
        }
        .content {
            padding: 20px;
        }
        .footer {
            background-color: #343a40;
            color: #ffffff;
            padding: 10px 0;
            text-align: center;
            position: fixed; /* 固定在页面底部 */
            bottom: 0; /* 从底部开始 */
            width: 100%; /* 使其宽度为100% */
            left: 0; /* 使其靠左 */
        }
        .main-table {
            margin-top: 20px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .container {
            display: flex;
            justify-content: space-between; /* 左右对齐 */
            align-items: flex-start; /* 上对齐 */
            padding: 10px;
        }
        .left {
            flex: 0 0 600px; /* 固定宽度为 400px */
            margin-right: 10px;
        }
        .right {
            flex: 1; /* 占据可用空间 */
            margin-left: 10px; /* 左边与右边组件之间的间距 */
        }
        #chat-box {
            width: 60%;
            max-width: 800px;
            min-width: 500px;
            height: 500px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #fff;
            padding: 20px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .message {
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 75%;
            line-height: 1.5;
            font-size: 16px;
            display: flex;
        }
        .user-message {
            background-color: #007bff;
            color: #fff;
            align-self: flex-end;
            border-bottom-right-radius: 0;
            margin-left: auto; /* 将用户消息框靠右 */
        }
        .bot-message {
            background-color: #e1e1e1;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 0;
            margin-right: auto; /* 将模型回复框靠左 */
        }
        #message-input {
            width: 60%;
            max-width: 800px;
            min-width: 300px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        #send-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
        }
        #send-button:hover {
            background-color: #0056b3;
        }
        .control-panel {
            margin-top: 20px;
        }
        .control-button {
            width: 50px;
            height: 50px;
            font-size: 18px;
            margin: 5px;
        }
        .control-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .image-gallery {
            width: 80%; /* 调整宽度为容器的80% */
            height: 400px; /* 设置固定高度 */
            margin-top: 20px;
            margin-left: 60px;
            margin-bottom: 20px;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <a class="navbar-brand" href="#">智慧矿井监测平台</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#" onclick="showSection('home')">首页</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('data')">实时数据</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('report')">监测报告</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('standard')">智能代理</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('control')">人工控制</a>
                </li>
            </ul>
        </div>
    </nav>

    <header class="header">
        <h1>智慧矿井监测平台</h1>
        <p>先进的矿井监测技术，保障矿井安全与高效运营</p>
    </header>

    <div class="container content">
        <div id="home" class="section active">
            <h2>工作动态</h2>
            <p>关于近期工作安排及动态的相关信息。</p>
            <div class="row" style="display: flex; width: 1000px; height: 500px; margin: 0 auto;">
                <div class="col-md-8">
                    <table class="table table-striped main-table">
                        <thead>
                            <tr>
                                <th scope="col">日期</th>
                                <th scope="col">动态</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- CSV数据将动态插入此处 -->
                        </tbody>
                    </table>
                </div>
                <div class="col-md-4" >
                    <h4>矿井概况</h4>
                    <p>当前矿井各部分监测数据展示。</p>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">矿井A</h5>
                            <p id="MQ3" class="card-text">MQ3： loading</p>
                            <p id="MQ135" class="card-text">MQ135： loading</p>
                            <p id="MQ9" class="card-text">MQ9： loading</p>
                            <p id="MQ2" class="card-text">MQ2： loading</p>
                            <p id="mine_condition" class="card-text">有害气体浓度：安全</p>
                            <p id="rfid" class="card-text">rfid检测信息： loading</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- <div id="about" class="section">
            <h2>平台简介</h2>
            <p>这里是平台简介的内容。</p>
        </div> -->

        <div id="data" class="section">
            <h2>实时数据</h2>
            <p>以下是近期矿井数据的变化图像。</p>
            <div class="image-gallery" id="imageGallery"></div>

            <h2>实时图像</h2>
            <!-- 添加视频流 -->
            <div class="image-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 100px;">
                <img src="http://192.168.43.198:5000/video_feed1" alt="Front Camera Stream" width="600" height="450" style="border:1px solid #ccc; border-radius: 10px;">
                <img src="http://192.168.43.234:5000/video_feed" alt="Rear Camera Stream" width="600" height="450" style="border:1px solid #ccc; border-radius: 10px;">
            </div>
            
            <!-- 如果你想继续使用 iframe -->
            <!-- <iframe src="http://192.168.43.198:5000/video_feed1" width="800" height="600" frameborder="0" allowfullscreen></iframe> -->
        </div>

        <div id="report" class="section">
            <h2>监测报告</h2>
            <p>这里是监测报告的内容。</p>
            <!-- 添加文件选择部分 -->
            <button id="button">重新生成</button>
            <div id="message"></div>
        </div>

        <script>
            document.getElementById('button').addEventListener('click', function() {
                fetch('/api/reload')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('message').innerText = data.message;
                    })
                    .catch(error => console.error('Error:', error));
            });
        </script>

        <div id="standard" class="section">
            <h2>智能监测分析代理</h2>
            <p>你可以与代理进行聊天，代理配有一些工具，可通过聊天的方式让代理通过工具执行一些任务</p>
            <div class="container" style="margin-bottom: 100px; margin-top: 50px;">
                <div id="chat-box-container" class="left">
                    <div id="chat-box"></div>
                    <input type="text" id="message-input" placeholder="Type your message here...">
                    <button id="send-button">Send</button>
                </div>
                
                <div class="right">
                    <div style="overflow: hidden; width: 282px; height: 330px;">
                        <iframe src="https://tmate.io/t/wNhMz787HzGL6cbYhYGkJuQqT" 
                                style="width: 1124px; height: 660px; transform-origin: center; margin-left: -260px; border: none;">
                        </iframe>
                    </div>
                </div>
            </div>


            <script>
                document.getElementById('send-button').addEventListener('click', function() {
                    var messageInput = document.getElementById('message-input');
                    var message = messageInput.value;
                    if (message.trim() === '') return;

                    var chatBox = document.getElementById('chat-box');
                    var userMessage = document.createElement('div');
                    userMessage.classList.add('message', 'user-message');
                    userMessage.textContent = message;
                    chatBox.appendChild(userMessage);

                    messageInput.value = '';
                    chatBox.scrollTop = chatBox.scrollHeight;

                    fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ message: message })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data); // 添加调试信息
                        var botMessage = document.createElement('div');
                        botMessage.classList.add('message', 'bot-message');
                        botMessage.textContent = data.reply;
                        chatBox.appendChild(botMessage);
                        chatBox.scrollTop = chatBox.scrollHeight;
                    })
                    .catch(error => console.error('Error:', error));
                });

                document.getElementById('message-input').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('send-button').click();
                    }
                });
            </script>
        </div>

        <div id="control" class="section">
            <h2>人工指令控制</h2>
            <p>你可以在这个界面进行远程操控检测车</p>
            <div class="image-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 100px;">
                <img src="http://192.168.43.198:5000/video_feed1" alt="Front Camera Stream" width="600" height="450" style="border:1px solid #ccc; border-radius: 10px;">
                <img src="http://192.168.43.234:5000/video_feed" alt="Rear Camera Stream" width="600" height="450" style="border:1px solid #ccc; border-radius: 10px;">
            </div>
        
            <div class="control-panel" style="margin-bottom: 100px; margin-left: 200px;">
                <button id="key-q" class="control-button">Q</button>
                <button id="key-w" class="control-button">W</button>
                <button id="key-e" class="control-button">E</button>
                <button id="key-u" class="control-button" style="margin-left: 400px;">U</button>
                <button id="key-i" class="control-button">I</button>
                <button id="key-o" class="control-button">O</button>
                <br>
                <button id="key-a" class="control-button">A</button>
                <button id="key-s" class="control-button">S</button>
                <button id="key-d" class="control-button">D</button>
                <button id="key-j" class="control-button" style="margin-left: 400px;">J</button>
                <button id="key-k" class="control-button">K</button>
                <button id="key-l" class="control-button">L</button>
            </div>
        
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // 按键映射
                    const keyMap = {
                        'q': 'key-q',
                        'w': 'key-w',
                        'e': 'key-e',
                        'a': 'key-a',
                        's': 'key-s',
                        'd': 'key-d',
                        'u': 'key-u',
                        'i': 'key-i',
                        'o': 'key-o',
                        'j': 'key-j',
                        'k': 'key-k',
                        'l': 'key-l'
                    };
        
        
                    // 监听按钮点击事件
                    document.querySelectorAll('.control-button').forEach(button => {
                        button.addEventListener('click', function() {
                            const key = this.textContent;
                            fetch('/control', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ key: key })
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Success:', data);
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                            });
                        });
                    });
                });
            </script>
        </div>

    <footer class="footer">
        <p>&copy; 2024瑞萨杯 智慧矿井监测平台 </p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        let keydownHandler = null;

        // 切换页面内容时的函数
        function showSection(sectionId) {
            console.log(`Showing section: ${sectionId}`);
            document.querySelectorAll('.section').forEach(function(section) {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            if (sectionId === 'control') {
                // 只在 "控制" 页面显示时添加键盘监听器
                if (keydownHandler === null) {
                    keydownHandler = function(event) {
                        if (event.key in keyMap) {
                            const buttonId = keyMap[event.key];
                            const button = document.getElementById(buttonId);
                            if (button) {
                                button.click();  // 模拟点击按钮
                                button.classList.add('active');  // 添加动画效果
                                setTimeout(() => button.classList.remove('active'), 100);  // 100毫秒后移除动画效果
                            }
                        }
                    };
                    document.addEventListener('keydown', keydownHandler);
                    console.log('Added keydownHandler');
                }
            } else {
                // 切换离开 "控制" 页面时移除键盘监听器
                if (keydownHandler !== null) {
                    console.log('Removing keydownHandler');
                    document.removeEventListener('keydown', keydownHandler);
                    keydownHandler = null;
                    console.log('Removed keydownHandler');
                }
            }
        }


        // 读取和解析CSV文件，并将数据插入表格
        function loadCSV() {
            fetch('/static/home_noticement.csv')
                .then(response => response.text())
                .then(data => {
                    Papa.parse(data, {
                        header: true,
                        dynamicTyping: true,
                        complete: function(results) {
                            const tableBody = document.getElementById('tableBody');
                            tableBody.innerHTML = ''; // 清空当前表格内容
                            results.data.forEach(row => {
                                const tr = document.createElement('tr');
                                const td1 = document.createElement('td');
                                td1.textContent = row['日期'];
                                const td2 = document.createElement('td');
                                td2.textContent = row['动态'];
                                tr.appendChild(td1);
                                tr.appendChild(td2);
                                tableBody.appendChild(tr);
                            });
                        }
                    });
                })
                .catch(error => console.error('Error loading CSV file:', error));
        }

        // 页面加载时读取CSV文件
        document.addEventListener('DOMContentLoaded', loadCSV);

        function updateData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('MQ3').textContent = `MQ3：${data.MQ3}`;
                    document.getElementById('MQ135').textContent = `MQ135：${data.MQ135}`;
                    document.getElementById('MQ9').textContent = `MQ9：${data.MQ9}`;
                    document.getElementById('MQ2').textContent = `MQ2：${data.MQ2}`;
                    document.getElementById('mine_condition').textContent = `矿井气体情况：${data.mine_condition}`;
                    document.getElementById('rfid').textContent = `rfid检测信息：${data.RFID}`;
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function loadImages() {
            fetch('/api/images')
                .then(response => response.json())
                .then(data => {
                    const figure = JSON.parse(data);
                    Plotly.react("imageGallery", figure.data, figure.layout);
                })
                .catch(error => console.error('Error loading images:', error));
        }

        // 在页面加载时请求文件内容
        function  init_summary(){
            fetch('/api/get_file_content')
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        document.getElementById('message').innerText = data.message;
                    }
                })
                .catch(error => console.error('Error:', error));
        }


        
        setInterval(init_summary, 2000);
        setInterval(updateData, 5000);
        setInterval(loadImages, 5000); 

    </script>
    <!-- <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> -->
    
</body>
</html>